apiVersion: v1
kind: Pod
metadata:
  name: {{ include "ssh-workspace.fullname" . }}-ssh-test
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ssh-workspace.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
    {{- with .Values.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  restartPolicy: Never
  containers:
  - name: ssh-connection-test
    image: alpine:3.18
    command:
    - /bin/sh
    - -c
    - |
      set -e
      echo "Testing SSH connection to workspace..."
      
      # Install OpenSSH client and netcat
      apk add --no-cache openssh-client netcat-openbsd
      
      # Test TCP connection
      echo "Testing TCP connection..."
      if ! nc -z {{ include "ssh-workspace.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local {{ .Values.service.port }}; then
        echo "Error: Cannot establish TCP connection to SSH service"
        exit 1
      fi
      echo "✓ TCP connection successful"
      
      # Test SSH protocol
      echo "Testing SSH protocol..."
      timeout 10 ssh -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no \
        {{ .Values.user.name }}@{{ include "ssh-workspace.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local \
        -p {{ .Values.service.port }} echo "SSH test" 2>&1 | grep -q "Permission denied" || {
        echo "Note: SSH protocol test completed (authentication expected to fail without keys)"
      }
      
      echo "✓ SSH service is responding correctly"
      echo "✓ SSH workspace is ready for connections"
    resources:
      limits:
        cpu: 100m
        memory: 64Mi
      requests:
        cpu: 50m
        memory: 32Mi