{{- if and .Values.tests.sshConnectivity.enabled .Values.ssh.testKeys.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "ssh-workspace.fullname" . }}-ssh-connectivity-test
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ssh-workspace.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  serviceAccountName: {{ include "ssh-workspace.fullname" . }}-test
  containers:
  - name: ssh-connectivity-test
    image: alpine:3.18
    command:
    - /bin/sh
    - -c
    - |
      # Remove set -e to prevent early exit and capture all debug info
      echo "=== SSH Connectivity Test Debug Information ==="
      echo "Start time: $(date)"
      echo "Pod hostname: $(hostname)"
      echo "Pod IP: $(hostname -i 2>/dev/null || echo 'IP_NOT_AVAILABLE')"
      
      echo "=== Environment Analysis ==="
      echo "Current user: $(id)"
      echo "Working directory: $(pwd)"
      echo "Available disk space:"
      df -h || echo "df command failed"
      
      echo "=== Network Interface Analysis ==="
      ip addr show || echo "ip command not available"
      ifconfig -a 2>/dev/null || echo "ifconfig not available"
      
      echo "=== DNS and Service Resolution ==="
      nslookup {{ include "ssh-workspace.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local 2>/dev/null || echo "nslookup failed"
      
      echo "=== Volume Mount Analysis ==="
      echo "Checking mounted volumes:"
      mount | grep test-ssh-keys || echo "test-ssh-keys volume not mounted"
      ls -la /test-ssh-keys/ 2>/dev/null || echo "Cannot access /test-ssh-keys directory"
      
      echo "=== ServiceAccount Analysis ==="
      echo "ServiceAccount token location:"
      ls -la /var/run/secrets/kubernetes.io/serviceaccount/ 2>/dev/null || echo "ServiceAccount token not found"
      
      echo "=== Secret Content Analysis ==="
      if [ -d /test-ssh-keys ]; then
        echo "test-ssh-keys directory exists"
        ls -la /test-ssh-keys/
        echo "Checking for test-key-0:"
        [ -f /test-ssh-keys/test-key-0 ] && echo "test-key-0 exists" || echo "test-key-0 NOT found"
      else
        echo "test-ssh-keys directory does NOT exist"
      fi
      
      echo "=== Package Installation Test ==="
      echo "Attempting package installation..."
      apk add --no-cache openssh-client netcat-openbsd 2>&1 || echo "Package installation failed"
      
      echo "=== Service Connectivity Test ==="
      SERVICE_FQDN="{{ include "ssh-workspace.fullname" . }}.{{ .Release.Namespace }}.svc.cluster.local"
      echo "Testing connectivity to: $SERVICE_FQDN"
      nc -z "$SERVICE_FQDN" {{ .Values.service.port }} 2>&1 && echo "TCP connection successful" || echo "TCP connection failed"
      
      echo "=== Debug Summary ==="
      echo "Pod started successfully and reached end of debug script"
      echo "End time: $(date)"
      
      # Instead of failing, sleep to keep pod alive for log collection
      echo "Sleeping for 30 seconds to allow log collection..."
      sleep 30
      
      echo "=== END OF DEBUG SESSION ==="
      
    volumeMounts:
    - name: test-ssh-keys
      mountPath: /test-ssh-keys
      readOnly: true
    resources:
      limits:
        cpu: 300m
        memory: 256Mi
      requests:
        cpu: 150m
        memory: 128Mi
  
  volumes:
  - name: test-ssh-keys
    secret:
      secretName: {{ include "ssh-workspace.fullname" . }}-test-ssh-keys
      defaultMode: 0600
{{- end }}